{% extends 'base.html' %}

{% block title %}Dashboard - Kabisakabisa ERP{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Dashboard Overview</h1>
    <div class="flex space-x-3">
        <a href="{% url 'sale_create' %}" class="btn btn-primary">New Sale</a>
        <a href="{% url 'order_create' %}" class="btn btn-outline">New Order</a>
    </div>
</div>

<!-- Financial Metrics -->
<div class="grid-4 mb-8">
    <div class="stat-card border-l-4 border-primary">
        <div class="stat-value text-primary">${{ monthly_sales|floatformat:2 }}</div>
        <div class="stat-label">Monthly Sales</div>
    </div>
    <div class="stat-card border-l-4 border-red-500">
        <div class="stat-value text-red-600">${{ monthly_expenses|floatformat:2 }}</div>
        <div class="stat-label">Monthly Expenses</div>
    </div>
    <div class="stat-card border-l-4 border-blue-500">
        <div class="stat-value text-blue-600">${{ monthly_profit|floatformat:2 }}</div>
        <div class="stat-label">Monthly Profit</div>
    </div>
    <div class="stat-card border-l-4 border-gray-500">
        <div class="stat-value text-gray-700">${{ total_sales|floatformat:2 }}</div>
        <div class="stat-label">Total Sales</div>
    </div>
</div>

<!-- Quick Stats -->
<div class="grid-4 mb-8">
    <div class="stat-card">
        <div class="stat-value">{{ total_branches }}</div>
        <div class="stat-label">Active Branches</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ total_products }}</div>
        <div class="stat-label">Products</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ pending_logistics }}</div>
        <div class="stat-label">Pending Logistics</div>
    </div>
    <div class="stat-card">
        <div class="stat-value text-red-600">{{ low_stock_items|length }}</div>
        <div class="stat-label">Low Stock Items</div>
    </div>
</div>

<!-- Alert Cards -->
<div class="grid-3 mb-8">
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-yellow-500">
        <div class="flex justify-between items-center">
            <span class="text-gray-700 font-semibold">Pending Orders</span>
            <span class="badge badge-warning text-lg">{{ pending_orders }}</span>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-blue-500">
        <div class="flex justify-between items-center">
            <span class="text-gray-700 font-semibold">Pending Transfers</span>
            <span class="badge badge-info text-lg">{{ pending_transfers }}</span>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-5 border-l-4 border-red-500">
        <div class="flex justify-between items-center">
            <span class="text-gray-700 font-semibold">Low Stock Alerts</span>
            <span class="badge badge-danger text-lg">{{ low_stock_items|length }}</span>
        </div>
    </div>
</div>

<!-- Event Flow Panel - Showing System Activity -->
<div class="mb-8">
    <div class="card">
        <div class="card-header">System Activity Flow</div>
        <div class="card-body">
            <div class="event-flow-panel">
                <div class="event-flow-step">
                    <div class="event-flow-title">Recent Sales Activity</div>
                    <div class="event-flow-description">
                        {{ recent_sales|length }} recent sale(s) recorded in the system
                    </div>
                    <div class="event-flow-time">Last updated: Today</div>
                </div>
                <div class="event-flow-step">
                    <div class="event-flow-title">Order Processing</div>
                    <div class="event-flow-description">
                        {{ pending_orders }} order(s) pending fulfillment
                    </div>
                    <div class="event-flow-time">Requires attention</div>
                </div>
                <div class="event-flow-step">
                    <div class="event-flow-title">Inventory Status</div>
                    <div class="event-flow-description">
                        {% if low_stock_items %}
                            ⚠️ {{ low_stock_items|length }} product(s) below minimum stock level
                        {% else %}
                            ✓ All inventory levels are healthy
                        {% endif %}
                    </div>
                    <div class="event-flow-time">Monitoring active</div>
                </div>
                <div class="event-flow-step">
                    <div class="event-flow-title">Logistics Operations</div>
                    <div class="event-flow-description">
                        {{ pending_logistics }} delivery operation(s) in progress
                    </div>
                    <div class="event-flow-time">Real-time tracking</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity Tables -->
<div class="grid-2 mb-8">
    <!-- Recent Sales -->
    <div class="card">
        <div class="card-header">Recent Sales</div>
        <div class="overflow-x-auto">
            {% if recent_sales %}
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Sale Number</th>
                        <th>Branch</th>
                        <th>Amount</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sale in recent_sales %}
                    <tr>
                        <td>
                            <a href="{% url 'sale_detail' sale.pk %}" class="text-primary hover:text-primary-dark font-semibold">
                                {{ sale.sale_number }}
                            </a>
                        </td>
                        <td>{{ sale.branch.name }}</td>
                        <td class="font-semibold text-green-600">${{ sale.total_amount|floatformat:2 }}</td>
                        <td class="text-gray-500 text-xs">{{ sale.created_at|date:"M d, H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <h3>No Sales Yet</h3>
                <p>Start by creating your first sale</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Recent Orders -->
    <div class="card">
        <div class="card-header">Recent Orders</div>
        <div class="overflow-x-auto">
            {% if recent_orders %}
            <table class="table-modern">
                <thead>
                    <tr>
                        <th>Order Number</th>
                        <th>Branch</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr>
                        <td>
                            <a href="{% url 'order_detail' order.pk %}" class="text-primary hover:text-primary-dark font-semibold">
                                {{ order.order_number }}
                            </a>
                        </td>
                        <td>{{ order.branch.name }}</td>
                        <td>
                            <span class="badge {% if order.status == 'COMPLETED' %}badge-success{% elif order.status == 'PENDING' %}badge-warning{% else %}badge-secondary{% endif %}">
                                {{ order.status }}
                            </span>
                        </td>
                        <td class="text-gray-500 text-xs">{{ order.created_at|date:"M d, H:i" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">
                <h3>No Orders Yet</h3>
                <p>Start by creating your first order</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Low Stock Alert Table -->
{% if low_stock_items %}
<div class="card">
    <div class="card-header flex justify-between items-center">
        <span>Low Stock Alerts</span>
        <span class="badge badge-danger">Requires Action</span>
    </div>
    <div class="overflow-x-auto">
        <table class="table-modern">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Branch</th>
                    <th>Current Quantity</th>
                    <th>Minimum Required</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for stock in low_stock_items %}
                <tr class="bg-red-50">
                    <td class="font-semibold">{{ stock.product.name }}</td>
                    <td>{{ stock.branch.name }}</td>
                    <td class="text-red-600 font-bold">{{ stock.quantity }}</td>
                    <td>{{ stock.min_quantity }}</td>
                    <td>
                        <span class="badge badge-danger">
                            Low Stock
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

{% endblock %}
