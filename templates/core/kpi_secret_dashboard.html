{% extends 'base.html' %}
{% load static %}

{% block title %}KPI Secret Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h4>KPI SECRET DASHBOARD - ADMIN ONLY</h4>
            <p class="text-muted">Advanced performance analytics with stock discrepancy impact analysis</p>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <small>Total Branches</small>
                    <h5 id="totalBranches">-</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <small>Avg Profit Margin</small>
                    <h5 id="avgProfitMargin">-</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <small>Avg Adjusted KPI</small>
                    <h5 id="avgAdjustedKPI">-</h5>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light">
                <div class="card-body">
                    <small>High Performers</small>
                    <h5 id="highPerformers">-</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Branch Performance Analysis -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-light">
                    <h6>Branch Performance Analysis</h6>
                    <button id="loadKPIData" class="btn btn-outline-secondary btn-sm float-right">Refresh Data</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="kpiTable">
                            <thead class="thead-light">
                                <tr>
                                    <th>Branch</th>
                                    <th>Revenue</th>
                                    <th>Gross Profit</th>
                                    <th>Profit Margin %</th>
                                    <th>Stock Discrepancy %</th>
                                    <th>Base KPI %</th>
                                    <th>Adjusted KPI %</th>
                                    <th>ROI %</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="kpiTableBody">
                                <tr>
                                    <td colspan="10" class="text-center">Click "Refresh Data" to load KPI analysis</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ROT Analysis Modal -->
    <div class="modal fade" id="rotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h6 class="modal-title">Rate of Turn (ROT) Analysis</h6>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Stock In</th>
                                    <th>Stock Out</th>
                                    <th>Avg Inventory</th>
                                    <th>ROT %</th>
                                    <th>Grade</th>
                                </tr>
                            </thead>
                            <tbody id="rotTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- KPI Explanation -->
    <div class="row">
        <div class="col-12">
            <div class="card border-secondary">
                <div class="card-header bg-light">
                    <h6>KPI Adjustment Logic</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Base KPI:</strong> Standard profit margin calculation</li>
                        <li><strong>Stock Discrepancy Impact:</strong> If profit margin ≥85% AND stock discrepancy ≥10% of revenue</li>
                        <li><strong>Penalty Applied:</strong> KPI reduced by 40% to account for potential inventory manipulation</li>
                        <li><strong>ROI Calculation:</strong> (Net Profit ÷ Total Investment) × 100</li>
                        <li><strong>ROT Grading:</strong> A(80%+), B(60-79%), C(40-59%), D(20-39%), F(<20%)</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loadKPIBtn = document.getElementById('loadKPIData');
    
    loadKPIBtn.addEventListener('click', function() {
        console.log('Loading KPI data...');
        fetch('/api/kpi-dashboard/')
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('KPI data received:', data);
                if (data.status === 'success') {
                    populateKPITable(data.data.branch_performances);
                    updateSummaryCards(data.data.summary);
                } else {
                    console.error('API Error:', data);
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                alert('Error loading KPI data: ' + error.message);
            });
    });
    
    function populateKPITable(branches) {
        const tbody = document.getElementById('kpiTableBody');
        tbody.innerHTML = '';
        
        branches.forEach(branch => {
            const statusClass = getStatusClass(branch.adjusted_kpi);
            const statusText = getStatusText(branch.adjusted_kpi);
            const penaltyApplied = branch.base_kpi !== branch.adjusted_kpi;
            
            const row = `
                <tr class="${statusClass}">
                    <td><strong>${branch.branch_name}</strong></td>
                    <td>$${branch.total_revenue.toLocaleString()}</td>
                    <td>$${branch.gross_profit.toLocaleString()}</td>
                    <td>${branch.profit_margin.toFixed(2)}%</td>
                    <td>${branch.stock_discrepancy_impact.toFixed(2)}%</td>
                    <td>${branch.base_kpi.toFixed(2)}%</td>
                    <td>
                        <span class="badge ${penaltyApplied ? 'badge-warning' : 'badge-success'}">
                            ${branch.adjusted_kpi.toFixed(2)}%
                            ${penaltyApplied ? ' (PENALTY)' : ''}
                        </span>
                    </td>
                    <td>${branch.roi.toFixed(2)}%</td>
                    <td><span class="badge ${statusClass.replace('table-', 'badge-')}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" onclick="showROTAnalysis('${branch.branch_name}', ${branch.rot_data ? JSON.stringify(branch.rot_data) : '[]'})">View ROT</button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
    
    function updateSummaryCards(summary) {
        document.getElementById('totalBranches').textContent = summary.total_branches;
        document.getElementById('avgProfitMargin').textContent = `${summary.avg_profit_margin.toFixed(1)}%`;
        document.getElementById('avgAdjustedKPI').textContent = `${summary.avg_adjusted_kpi.toFixed(1)}%`;
        document.getElementById('highPerformers').textContent = summary.high_performing_branches;
    }
    
    function getStatusClass(kpi) {
        if (kpi >= 70) return 'table-success';
        if (kpi >= 50) return 'table-warning';
        return 'table-warning';
    }
    
    function getStatusText(kpi) {
        if (kpi >= 70) return 'EXCELLENT';
        if (kpi >= 50) return 'GOOD';
        return 'NEEDS ATTENTION';
    }
    
    // Auto-load data on page load
    setTimeout(() => {
        loadKPIBtn.click();
    }, 1000);
});

function showROTAnalysis(branchName, rotData) {
    document.querySelector('#rotModal .modal-title').textContent = `ROT Analysis - ${branchName}`;
    
    const tbody = document.getElementById('rotTableBody');
    tbody.innerHTML = '';
    
    if (rotData && rotData.length > 0) {
        rotData.forEach(product => {
            const gradeClass = getGradeClass(product.flow_grade);
            const row = `
                <tr>
                    <td>${product.product_name}</td>
                    <td>${product.stock_in}</td>
                    <td>${product.stock_out}</td>
                    <td>${product.avg_inventory.toFixed(2)}</td>
                    <td>${product.rot_percentage.toFixed(2)}%</td>
                    <td><span class="badge ${gradeClass}">${product.flow_grade}</span></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    } else {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No ROT data available for this branch</td></tr>';
    }
    
    $('#rotModal').modal('show');
}

function getGradeClass(grade) {
    switch(grade) {
        case 'A': return 'badge-success';
        case 'B': return 'badge-primary';
        case 'C': return 'badge-warning';
        case 'D': return 'badge-secondary';
        case 'F': return 'badge-warning';
        default: return 'badge-light';
    }
}
</script>
{% endblock %}