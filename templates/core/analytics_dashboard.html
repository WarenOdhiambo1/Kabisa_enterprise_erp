{% extends 'base.html' %}

{% block title %}Financial Analytics Dashboard{% endblock %}

{% block content %}
<div class="analytics-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">Financial Analytics Dashboard</h1>
            <p class="dashboard-subtitle">Enterprise-grade financial intelligence powered by Fortune 500 algorithms</p>
        </div>
        <div class="dashboard-controls">
            <select class="form-select" onchange="updateDashboard()" id="branchSelect">
                <option value="">All Branches</option>
                {% for branch in branches %}
                <option value="{{ branch.id }}" {% if selected_branch == branch.id|stringformat:"s" %}selected{% endif %}>{{ branch.name }}</option>
                {% endfor %}
            </select>
            <select class="form-select" onchange="updateDashboard()" id="periodSelect">
                <option value="30" {% if selected_period == 30 %}selected{% endif %}>Last Month</option>
                <option value="90" {% if selected_period == 90 %}selected{% endif %}>Last Quarter</option>
                <option value="365" {% if selected_period == 365 %}selected{% endif %}>Last Year</option>
            </select>
        </div>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card revenue">
            <div class="kpi-icon">üí∞</div>
            <div class="kpi-content">
                <h3>${{ metrics.total_revenue|floatformat:2 }}</h3>
                <p>Total Revenue</p>
            </div>
        </div>
        <div class="kpi-card profit">
            <div class="kpi-icon">üìà</div>
            <div class="kpi-content">
                <h3>${{ metrics.net_profit|floatformat:2 }}</h3>
                <p>Net Profit</p>
            </div>
        </div>
        <div class="kpi-card margin">
            <div class="kpi-icon">üìä</div>
            <div class="kpi-content">
                <h3>{{ metrics.profit_margin|floatformat:1 }}%</h3>
                <p>Profit Margin</p>
            </div>
        </div>
        <div class="kpi-card risk">
            <div class="kpi-icon">‚ö†Ô∏è</div>
            <div class="kpi-content">
                <h3>{{ risk_data.risk_level }}</h3>
                <p>Risk Level</p>
            </div>
        </div>
    </div>

    <!-- Analytics Grid -->
    <div class="analytics-grid">
        <!-- Sales Forecast -->
        <div class="analytics-card">
            <div class="card-header">
                <h3>AI Sales Forecast <span class="algorithm-badge">Prophet ML</span></h3>
            </div>
            <div class="card-content">
                <div class="forecast-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Period</th>
                                <th>Predicted Sales</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in forecast_data %}
                            <tr>
                                <td>{{ item.period }}</td>
                                <td>${{ item.predicted_sales }}</td>
                                <td>{{ item.confidence }}%</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="3">Insufficient data for forecasting</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="algorithm-credit">Powered by Facebook's Prophet Algorithm</div>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="analytics-card">
            <div class="card-header">
                <h3>Risk Assessment <span class="algorithm-badge">VaR Model</span></h3>
            </div>
            <div class="card-content">
                <div class="risk-metrics">
                    <div class="risk-item">
                        <span class="metric-label">Value at Risk (95%)</span>
                        <span class="metric-value">${{ risk_data.var_95 }}</span>
                        <span class="status-badge {% if risk_data.var_95 < 0 %}danger{% else %}success{% endif %}">
                            {% if risk_data.var_95 < 0 %}Risk{% else %}Safe{% endif %}
                        </span>
                    </div>
                    <div class="risk-item">
                        <span class="metric-label">Volatility</span>
                        <span class="metric-value">{{ risk_data.volatility }}%</span>
                        <span class="status-badge {% if risk_data.volatility > 50 %}danger{% elif risk_data.volatility > 20 %}warning{% else %}success{% endif %}">
                            {% if risk_data.volatility > 50 %}High{% elif risk_data.volatility > 20 %}Medium{% else %}Low{% endif %}
                        </span>
                    </div>
                    <div class="risk-item">
                        <span class="metric-label">Daily Average</span>
                        <span class="metric-value">${{ risk_data.mean_daily_sales }}</span>
                        <span class="status-badge info">Stable</span>
                    </div>
                </div>
                <div class="algorithm-credit">Value at Risk (VaR) Analysis</div>
            </div>
        </div>

        <!-- Inventory Optimization -->
        <div class="analytics-card">
            <div class="card-header">
                <h3>Smart Inventory <span class="algorithm-badge">EOQ Model</span></h3>
            </div>
            <div class="card-content">
                <div class="inventory-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Current Stock</th>
                                <th>Reorder Point</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in inventory_data %}
                            <tr>
                                <td>{{ item.product|truncatechars:20 }}</td>
                                <td>{{ item.current_stock }}</td>
                                <td>{{ item.reorder_point }}</td>
                                <td>
                                    <span class="status-badge {% if item.status == 'Reorder' %}danger{% else %}success{% endif %}">
                                        {{ item.status }}
                                    </span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">No inventory data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="algorithm-credit">Amazon & Walmart Algorithm</div>
            </div>
        </div>

        <!-- Route Optimization -->
        <div class="analytics-card">
            <div class="card-header">
                <h3>Route Optimization <span class="algorithm-badge">Linear Programming</span></h3>
            </div>
            <div class="card-content">
                <div class="route-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Route</th>
                                <th>Distance (km)</th>
                                <th>Profit</th>
                                <th>Efficiency</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in route_data %}
                            <tr>
                                <td>{{ item.route|truncatechars:25 }}</td>
                                <td>{{ item.distance }}</td>
                                <td>${{ item.profit }}</td>
                                <td>{{ item.efficiency }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4">No route data available</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="algorithm-credit">UPS & FedEx Algorithm</div>
            </div>
        </div>
    </div>

    <!-- Revenue Chart -->
    <div class="chart-section">
        <div class="analytics-card full-width">
            <div class="card-header">
                <h3>Revenue Trend Analysis</h3>
            </div>
            <div class="card-content">
                <canvas id="revenueChart" width="400" height="100"></canvas>
            </div>
        </div>
    </div>

    <!-- Report Generation -->
    <div class="report-section">
        <div class="analytics-card">
            <div class="card-header">
                <h3>Professional Reports <span class="algorithm-badge">Investment Grade</span></h3>
            </div>
            <div class="card-content">
                <p>Generate Fortune 500 quality financial reports with advanced analytics</p>
                <div class="report-buttons">
                    <button class="btn btn-primary" onclick="generateReport('executive')">Executive Summary</button>
                    <button class="btn btn-secondary" onclick="generateReport('detailed')">Detailed Analysis</button>
                    <button class="btn btn-success" onclick="generateReport('investor')">Investor Report</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-dashboard {
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    background: rgba(255,255,255,0.1);
    padding: 20px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
}

.dashboard-title {
    color: white;
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
}

.dashboard-subtitle {
    color: rgba(255,255,255,0.8);
    margin: 5px 0 0 0;
    font-size: 1.1rem;
}

.dashboard-controls {
    display: flex;
    gap: 15px;
}

.dashboard-controls select {
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 8px;
    padding: 10px 15px;
}

.kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.kpi-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    display: flex;
    align-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-5px);
}

.kpi-icon {
    font-size: 3rem;
    margin-right: 20px;
}

.kpi-content h3 {
    font-size: 2rem;
    font-weight: 700;
    margin: 0;
    color: #2c3e50;
}

.kpi-content p {
    margin: 5px 0 0 0;
    color: #7f8c8d;
    font-weight: 500;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.analytics-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

.analytics-card.full-width {
    grid-column: 1 / -1;
}

.card-header {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.card-header h3 {
    margin: 0;
    font-weight: 600;
}

.algorithm-badge {
    background: rgba(255,255,255,0.2);
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
}

.card-content {
    padding: 20px;
}

.forecast-table table,
.inventory-table table,
.route-table table {
    width: 100%;
    border-collapse: collapse;
}

.forecast-table th,
.inventory-table th,
.route-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
}

.forecast-table td,
.inventory-table td,
.route-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.risk-metrics {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.risk-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.metric-label {
    font-weight: 600;
    color: #2c3e50;
}

.metric-value {
    font-weight: 700;
    font-size: 1.2rem;
    color: #3498db;
}

.status-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.success {
    background: #d4edda;
    color: #155724;
}

.status-badge.danger {
    background: #f8d7da;
    color: #721c24;
}

.status-badge.warning {
    background: #fff3cd;
    color: #856404;
}

.status-badge.info {
    background: #d1ecf1;
    color: #0c5460;
}

.algorithm-credit {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
    font-size: 0.9rem;
    color: #6c757d;
    font-style: italic;
}

.report-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.report-buttons button {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-success {
    background: #27ae60;
    color: white;
}

.report-buttons button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        gap: 20px;
    }
    
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .report-buttons {
        flex-direction: column;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Revenue Chart
const chartData = {{ chart_data|safe }};
const ctx = document.getElementById('revenueChart').getContext('2d');

new Chart(ctx, {
    type: 'line',
    data: {
        labels: chartData.map(item => item.month),
        datasets: [{
            label: 'Revenue',
            data: chartData.map(item => item.revenue),
            borderColor: '#3498db',
            backgroundColor: 'rgba(52, 152, 219, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        }
    }
});

function updateDashboard() {
    const branch = document.getElementById('branchSelect').value;
    const period = document.getElementById('periodSelect').value;
    
    const params = new URLSearchParams();
    if (branch) params.append('branch', branch);
    if (period) params.append('period', period);
    
    window.location.href = '?' + params.toString();
}

function generateReport(type) {
    alert(`Generating ${type} report... This feature will be implemented with PDF generation.`);
}

// Auto-refresh every 5 minutes
setInterval(() => {
    location.reload();
}, 300000);
</script>
{% endblock %}